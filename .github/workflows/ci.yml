name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # ---------------------------------------------------------------------------
  # Phase 1: StrandLink (Zig 0.13)
  # ---------------------------------------------------------------------------
  strandlink:
    name: StrandLink (Zig)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: strandlink
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Zig 0.13.x
        uses: mlugg/setup-zig@v2
        with:
          version: 0.13.0

      - name: Cache Zig build artifacts
        uses: actions/cache@v4
        with:
          path: |
            strandlink/.zig-cache
            strandlink/zig-out
          key: zig-${{ runner.os }}-${{ hashFiles('strandlink/build.zig', 'strandlink/src/**') }}
          restore-keys: |
            zig-${{ runner.os }}-

      - name: Build
        run: zig build

      - name: Test
        run: zig build test

  # ---------------------------------------------------------------------------
  # Phase 2: StrandRoute (C / CMake)
  # ---------------------------------------------------------------------------
  strandroute:
    name: StrandRoute (C)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: strandroute
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake clang

      - name: Cache CMake build directory
        uses: actions/cache@v4
        with:
          path: strandroute/build
          key: cmake-${{ runner.os }}-${{ hashFiles('strandroute/CMakeLists.txt', 'strandroute/src/**', 'strandroute/include/**') }}
          restore-keys: |
            cmake-${{ runner.os }}-

      - name: Configure
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_C_COMPILER=clang -DCMAKE_BUILD_TYPE=Debug -DENABLE_ASAN=ON

      - name: Build
        run: cmake --build build --parallel

      - name: Test
        run: |
          cd build
          ctest --output-on-failure

  # ---------------------------------------------------------------------------
  # Phase 3: Rust (strandstream + strandtrust)
  # ---------------------------------------------------------------------------
  rust:
    name: Rust (strandstream + strandtrust)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache Cargo registry and build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: cargo-${{ runner.os }}-${{ hashFiles('Cargo.lock', 'Cargo.toml', 'strandtrust/Cargo.toml', 'strandstream/Cargo.toml') }}
          restore-keys: |
            cargo-${{ runner.os }}-

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      # ---- strandtrust ----
      - name: "strandtrust: check formatting"
        working-directory: strandtrust
        run: cargo fmt --check

      - name: "strandtrust: clippy"
        working-directory: strandtrust
        run: cargo clippy --all-targets --all-features -- -D warnings -D clippy::pedantic -A clippy::missing_errors_doc -A clippy::missing_panics_doc

      - name: "strandtrust: audit"
        working-directory: strandtrust
        run: cargo audit

      - name: "strandtrust: build"
        working-directory: strandtrust
        run: cargo build

      - name: "strandtrust: test"
        working-directory: strandtrust
        run: cargo test

      # ---- strandstream ----
      - name: "strandstream: check formatting"
        working-directory: strandstream
        run: cargo fmt --check

      - name: "strandstream: clippy"
        working-directory: strandstream
        run: cargo clippy --all-targets --all-features -- -D warnings -D clippy::pedantic -A clippy::missing_errors_doc -A clippy::missing_panics_doc

      - name: "strandstream: audit"
        working-directory: strandstream
        run: cargo audit

      - name: "strandstream: build"
        working-directory: strandstream
        run: cargo build

      - name: "strandstream: test"
        working-directory: strandstream
        run: cargo test

  # ---------------------------------------------------------------------------
  # Phase 4-5: Go (strandapi + strandctl + strand-cloud)
  # ---------------------------------------------------------------------------
  go:
    name: Go (strandapi + strandctl + strand-cloud)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"
          cache: false

      - name: Cache Go module and build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: go-${{ runner.os }}-${{ hashFiles('go.work', 'strandctl/go.sum', 'strandctl/go.mod', 'strandapi/go.mod', 'strand-cloud/go.mod') }}
          restore-keys: |
            go-${{ runner.os }}-

      - name: Install staticcheck and govulncheck
        run: |
          go install honnef.co/go/tools/cmd/staticcheck@latest
          go install golang.org/x/vuln/cmd/govulncheck@latest

      # ---- strandapi ----
      - name: "strandapi: build"
        working-directory: strandapi
        run: go build ./...

      - name: "strandapi: test (with race detector)"
        working-directory: strandapi
        run: go test -race ./...

      - name: "strandapi: vet"
        working-directory: strandapi
        run: go vet ./...

      - name: "strandapi: staticcheck"
        working-directory: strandapi
        run: staticcheck ./...

      - name: "strandapi: govulncheck"
        working-directory: strandapi
        run: govulncheck ./...

      # ---- strandctl ----
      - name: "strandctl: build"
        working-directory: strandctl
        run: go build ./...

      - name: "strandctl: test (with race detector)"
        working-directory: strandctl
        run: go test -race ./...

      - name: "strandctl: vet"
        working-directory: strandctl
        run: go vet ./...

      - name: "strandctl: staticcheck"
        working-directory: strandctl
        run: staticcheck ./...

      - name: "strandctl: govulncheck"
        working-directory: strandctl
        run: govulncheck ./...

      # ---- strand-cloud ----
      - name: "strand-cloud: build"
        working-directory: strand-cloud
        run: go build ./...

      - name: "strand-cloud: test (with race detector)"
        working-directory: strand-cloud
        run: go test -race ./...

      - name: "strand-cloud: vet"
        working-directory: strand-cloud
        run: go vet ./...

      - name: "strand-cloud: staticcheck"
        working-directory: strand-cloud
        run: staticcheck ./...

      - name: "strand-cloud: govulncheck"
        working-directory: strand-cloud
        run: govulncheck ./...

  # ---------------------------------------------------------------------------
  # Integration gate: cross-module verification
  # ---------------------------------------------------------------------------
  integration:
    name: Integration Verification
    runs-on: ubuntu-latest
    needs: [strandlink, strandroute, rust, go]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Zig 0.13.x
        uses: mlugg/setup-zig@v2
        with:
          version: 0.13.0

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake clang

      - name: Build strandlink
        working-directory: strandlink
        run: zig build

      - name: Build strandroute
        working-directory: strandroute
        run: |
          mkdir -p build && cd build
          cmake .. -DCMAKE_C_COMPILER=clang -DCMAKE_BUILD_TYPE=Release \
            -DSTRANDLINK_INCLUDE_DIR=../../strandlink/include \
            -DSTRANDLINK_LIB_DIR=../../strandlink/zig-out/lib
          cmake --build . --parallel

      - name: Build strandtrust
        working-directory: strandtrust
        run: cargo build --release

      - name: Build strandstream
        working-directory: strandstream
        run: cargo build --release

      - name: Build strandapi
        working-directory: strandapi
        run: CGO_ENABLED=0 go build ./...

      - name: Build strandctl
        working-directory: strandctl
        run: go build ./...

      - name: Build strand-cloud
        working-directory: strand-cloud
        run: go build ./...

      - name: Run integration tests
        working-directory: tests/integration
        run: go test ./... -v -timeout 120s

      - name: Cross-module verification
        run: |
          set -e
          echo "=== Cross-Module Verification ==="
          echo ""
          fail=0
          check() {
            if [ -e "$1" ]; then
              echo "  OK  $2"
            else
              echo "  MISSING  $2 (expected: $1)"
              fail=1
            fi
          }
          check strandlink/zig-out/lib/libstrandlink.a     "strandlink static library"
          check strandlink/include/strandlink.h             "strandlink C header"
          check strandroute/build/libstrandroute.a          "strandroute static library"
          check strandroute/build/strandroute_tests         "strandroute test binary"
          check target/release/libstrandtrust.a            "strandtrust static library"
          check target/release/libstrandstream.a           "strandstream static library"
          echo ""
          if [ "$fail" -ne 0 ]; then
            echo "FAILED: one or more expected artifacts are missing."
            exit 1
          fi
          echo "Dependency graph validated: all modules build successfully in order."
          echo "=== Integration verification passed ==="
