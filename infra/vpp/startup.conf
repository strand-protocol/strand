##############################################################################
# VPP Startup Configuration for Nexus Protocol
#
# Tuned for container-mode operation: DPDK disabled (no PCI access),
# TAP interfaces used for inter-container connectivity.
#
# Network topology:
#   tap0  - 172.21.0.254/24  (VPP gateway on data-net)
#   tap1  - 172.21.0.1/32    (nexus-node-1 peer)
#   tap2  - 172.21.0.2/32    (nexus-node-2 peer)
#
# Ref: https://fd.io/docs/vpp/master/gettingstarted/users/configuring/startup.html
##############################################################################

unix {
  ## Run in foreground (we use the docker entrypoint for daemonization)
  nodaemon

  ## VPP log file (container bind-mount or local)
  log /var/log/vpp/vpp.log

  ## CLI socket for vppctl access
  cli-listen /run/vpp/cli.sock

  ## Startup script: configure TAP interfaces after VPP core init
  ## (Alternatively, setup.sh polls and runs after VPP is ready.)
  ## startup-config /etc/vpp/setup.gate

  ## Dump core on panic (useful for debugging in dev containers)
  full-coredump

  ## gid for cli socket group (docker typically runs as root)
  gid root
}

##############################################################################
# API trace -- capture every binary API message for replay/debugging
##############################################################################

api-trace {
  on
}

##############################################################################
# DPDK -- disabled for container mode
#
# Containers do not have direct PCI access to physical NICs.
# We rely on Linux TAP virtual interfaces instead.
##############################################################################

dpdk {
  no-pci
}

##############################################################################
# Buffer configuration
#
# 131072 buffers per NUMA node provides ample headroom for lab traffic.
# Lower this to ~8192 for memory-constrained environments.
##############################################################################

buffers {
  buffers-per-numa 131072
}

##############################################################################
# CPU pinning
#
# main-core 0  : VPP main thread on CPU 0
# workers 0    : no worker threads in single-core container mode
#
# Increase workers and adjust main-core for multi-core deployments.
##############################################################################

cpu {
  main-core 0
  workers 0
}

##############################################################################
# Statistics segment
#
# Exposes /run/vpp/stats.sock for Prometheus scraping via vpp-prometheus-exporter.
# "default" uses shared-memory segment with default 512MB size.
##############################################################################

statseg {
  default
}

##############################################################################
# Logging
##############################################################################

logging {
  default-log-level notice
  default-syslog-log-level warning
}
