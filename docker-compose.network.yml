##############################################################################
# docker-compose.network.yml - Strand Protocol Multi-Node Topology
#
# Brings up the full Strand Protocol stack for integration testing and demos:
#
#   Management plane (mgmt-net: 172.20.0.0/24)
#     etcd          172.20.0.10   -- distributed state store
#     strand-cloud   172.20.0.20   -- control plane API server
#     strand-node-1  172.20.0.11   -- AI inference node
#     strand-node-2  172.20.0.12   -- AI inference node
#     strand-node-3  172.20.0.13   -- AI inference node
#     strandctl-init (ephemeral)   -- one-shot registration job
#
#   Data plane (data-net: 172.21.0.0/24)
#     vpp           172.21.0.254  -- FD.io VPP gateway / TAP forwarder
#     bmv2          172.21.0.253  -- BMv2 P4 programmable switch
#     strand-node-1  172.21.0.11
#     strand-node-2  172.21.0.12
#     strand-node-3  172.21.0.13
#
#   P4 control plane (p4-net: 172.22.0.0/24)
#     bmv2          172.22.0.10   -- Thrift RPC port 9090
#
# Usage:
#   docker compose -f docker-compose.network.yml up --build
#   docker compose -f docker-compose.network.yml down -v
#
# To scale nodes (e.g. 5 instead of 3):
#   docker compose -f docker-compose.network.yml up --scale strand-node-1=1 ...
##############################################################################

networks:
  # Management network: control-plane communication between strand-cloud,
  # strandctl, and node agents.
  mgmt-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24

  # Data network: StrandLink/StrandStream traffic between nodes and the VPP / BMv2
  # forwarding planes.
  data-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/24

  # P4 control network: Thrift RPC between StrandRoute control plane and BMv2.
  p4-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/24

services:

  # --------------------------------------------------------------------------
  # etcd - Distributed State Store
  #
  # Used by strand-cloud for routing entries, node registrations, and leader
  # election.  In dev mode ALLOW_NONE_AUTHENTICATION=yes skips TLS.
  # --------------------------------------------------------------------------
  etcd:
    image: bitnami/etcd:3.5
    environment:
      - ALLOW_NONE_AUTHENTICATION=yes
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd:2379
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_DATA_DIR=/bitnami/etcd/data
    ports:
      - "2379:2379"
    networks:
      mgmt-net:
        ipv4_address: 172.20.0.10
    volumes:
      - etcd-data:/bitnami/etcd
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 5s
      timeout: 3s
      retries: 5

  # --------------------------------------------------------------------------
  # VPP - FD.io Vector Packet Processor
  #
  # Runs in container mode (no-pci DPDK).  Creates TAP interfaces, configures
  # an L2 bridge domain for StrandLink EtherType 0x9100, and routes 172.21.0.0/24.
  #
  # Requires: NET_ADMIN + SYS_PTRACE capabilities, hugepages volume.
  # --------------------------------------------------------------------------
  vpp:
    build:
      context: ./infra/vpp
      dockerfile: Dockerfile
    cap_add:
      - NET_ADMIN
      - SYS_PTRACE
    volumes:
      # Hugepages: VPP allocates huge pages even without DPDK for mempool perf
      - /dev/hugepages:/dev/hugepages
      # Named volume for CLI socket (/run/vpp/cli.sock) shared with vppctl
      - vpp-run:/run/vpp
    networks:
      data-net:
        ipv4_address: 172.21.0.254
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # BMv2 - P4 Behavioral Model Switch
  #
  # Compiles strandroute/p4/sad_forward.p4 at image build time (or uses a stub
  # JSON if p4c is unavailable).  Exposes port 9090 for Thrift RPC so that
  # the StrandRoute p4_runtime.c client can install SAD and forwarding entries.
  #
  # Build context is the repo root so Dockerfile can COPY strandroute/p4/.
  # --------------------------------------------------------------------------
  bmv2:
    build:
      context: .
      dockerfile: infra/bmv2/Dockerfile
    networks:
      p4-net:
        ipv4_address: 172.22.0.10
      data-net:
        ipv4_address: 172.21.0.253
    ports:
      # Thrift RPC for P4 control-plane (p4_runtime.c)
      - "9090:9090"
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # strand-cloud - Control Plane API Server
  #
  # All-in-one binary (cmd/allinone) with in-memory store (dev) or etcd
  # (production).  Exposes REST + gRPC on port 8080.
  # --------------------------------------------------------------------------
  strand-cloud:
    build:
      context: ./strand-cloud
      dockerfile: Dockerfile
    environment:
      - STRAND_ADDR=0.0.0.0:8080
      - STRAND_STORE_TYPE=etcd
      - STRAND_ETCD_ENDPOINTS=http://etcd:2379
    ports:
      - "8080:8080"
    networks:
      mgmt-net:
        ipv4_address: 172.20.0.20
    depends_on:
      etcd:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/healthcheck"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # strand-node-1 - AI Inference Node (text_generation, code_generation)
  #
  # Runs strandapi-httpbridge: the OpenAI-compatible HTTP bridge that translates
  # REST requests to StrandAPI protocol messages.
  # --------------------------------------------------------------------------
  strand-node-1:
    build:
      context: ./strandapi
      dockerfile: Dockerfile
    entrypoint: ["/strandapi-httpbridge", "0.0.0.0:9000"]
    environment:
      - STRANDAPI_ADDR=0.0.0.0:9000
      - STRAND_CLOUD_ADDR=http://strand-cloud:8080
      - NODE_CAPABILITIES=text_generation,code_generation
    ports:
      - "9010:9000"
    networks:
      mgmt-net:
        ipv4_address: 172.20.0.11
      data-net:
        ipv4_address: 172.21.0.11
    depends_on:
      strand-cloud:
        condition: service_healthy
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # strand-node-2 - AI Inference Node (reasoning, vision)
  # --------------------------------------------------------------------------
  strand-node-2:
    build:
      context: ./strandapi
      dockerfile: Dockerfile
    entrypoint: ["/strandapi-httpbridge", "0.0.0.0:9000"]
    environment:
      - STRANDAPI_ADDR=0.0.0.0:9000
      - STRAND_CLOUD_ADDR=http://strand-cloud:8080
      - NODE_CAPABILITIES=reasoning,vision
    ports:
      - "9011:9000"
    networks:
      mgmt-net:
        ipv4_address: 172.20.0.12
      data-net:
        ipv4_address: 172.21.0.12
    depends_on:
      strand-cloud:
        condition: service_healthy
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # strand-node-3 - AI Inference Node (multimodal, tools)
  # --------------------------------------------------------------------------
  strand-node-3:
    build:
      context: ./strandapi
      dockerfile: Dockerfile
    entrypoint: ["/strandapi-httpbridge", "0.0.0.0:9000"]
    environment:
      - STRANDAPI_ADDR=0.0.0.0:9000
      - STRAND_CLOUD_ADDR=http://strand-cloud:8080
      - NODE_CAPABILITIES=multimodal,tools
    ports:
      - "9012:9000"
    networks:
      mgmt-net:
        ipv4_address: 172.20.0.13
      data-net:
        ipv4_address: 172.21.0.13
    depends_on:
      strand-cloud:
        condition: service_healthy
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # strandctl-init - One-Shot Node Registration Job
  #
  # Waits for strand-cloud to be healthy, then uses strandctl to register all
  # nodes.  restart: "no" ensures it runs exactly once.
  # --------------------------------------------------------------------------
  strandctl-init:
    build:
      context: ./strandctl
      dockerfile: Dockerfile
    command: ["sh", "-c", "sleep 5 && strandctl node register --all --server http://strand-cloud:8080"]
    networks:
      - mgmt-net
    depends_on:
      strand-cloud:
        condition: service_healthy
    restart: "no"

volumes:
  # etcd persistent state
  etcd-data:
  # VPP runtime directory (CLI socket, stats socket)
  vpp-run:
