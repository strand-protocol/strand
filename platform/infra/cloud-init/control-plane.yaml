#cloud-config
# Strand Protocol -- Control Plane Node First-Boot Configuration
# Variables: ${HOSTNAME}, ${ENVIRONMENT}, ${NODE_INDEX}, ${ROLE}

hostname: ${HOSTNAME}
manage_etc_hosts: true
fqdn: ${HOSTNAME}.strand-protocol.local

users:
  - name: strand
    groups: sudo, docker
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys: []
    lock_passwd: true

package_update: true
package_upgrade: true

packages:
  - curl
  - wget
  - jq
  - htop
  - iotop
  - net-tools
  - fail2ban
  - ufw
  - unzip
  - git
  - build-essential
  - ca-certificates
  - gnupg
  - lsb-release
  - apt-transport-https
  - software-properties-common
  - prometheus-node-exporter
  - ntp
  - logrotate

write_files:
  - path: /etc/strand/node.conf
    permissions: "0644"
    content: |
      # Strand Protocol Node Configuration
      NODE_ROLE=${ROLE}
      NODE_INDEX=${NODE_INDEX}
      ENVIRONMENT=${ENVIRONMENT}
      HOSTNAME=${HOSTNAME}
      STRAND_OVERLAY_PORT=6477
      STRAND_API_PORT=8080
      STRAND_METRICS_PORT=9090

  - path: /etc/ufw/applications.d/strand
    permissions: "0644"
    content: |
      [Strand-Overlay]
      title=StrandLink Overlay Protocol
      description=StrandLink L1 overlay transport (UDP)
      ports=6477/udp

      [Strand-API]
      title=Strand API Server
      description=Strand Cloud API server (HTTP)
      ports=8080/tcp

      [Strand-HTTPS]
      title=Strand HTTPS
      description=HTTPS ingress via Caddy
      ports=443/tcp

      [Strand-Prometheus]
      title=Prometheus
      description=Prometheus metrics server
      ports=9090/tcp

      [Strand-Grafana]
      title=Grafana
      description=Grafana dashboard
      ports=3000/tcp

  - path: /etc/sysctl.d/99-strand-tuning.conf
    permissions: "0644"
    content: |
      # Network performance tuning for Strand Protocol
      net.core.rmem_max=16777216
      net.core.wmem_max=16777216
      net.core.rmem_default=1048576
      net.core.wmem_default=1048576
      net.core.netdev_max_backlog=5000
      net.ipv4.tcp_rmem=4096 1048576 16777216
      net.ipv4.tcp_wmem=4096 1048576 16777216
      net.ipv4.tcp_congestion_control=cubic
      net.ipv4.tcp_fastopen=3
      net.ipv4.udp_rmem_min=8192
      net.ipv4.udp_wmem_min=8192
      # Increase UDP buffer for StrandLink overlay
      net.core.optmem_max=65536
      # File descriptor limits
      fs.file-max=2097152
      # VM tuning
      vm.swappiness=10
      vm.dirty_ratio=60
      vm.dirty_background_ratio=2

  - path: /etc/security/limits.d/99-strand.conf
    permissions: "0644"
    content: |
      strand soft nofile 1048576
      strand hard nofile 1048576
      strand soft nproc 65535
      strand hard nproc 65535
      root soft nofile 1048576
      root hard nofile 1048576

  - path: /etc/fail2ban/jail.local
    permissions: "0644"
    content: |
      [DEFAULT]
      bantime = 3600
      findtime = 600
      maxretry = 5

      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      logpath = /var/log/auth.log

runcmd:
  # Apply sysctl tuning
  - sysctl --system

  # Configure UFW firewall
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow ssh
  - ufw allow 6477/udp comment "StrandLink overlay"
  - ufw allow 8080/tcp comment "Strand API"
  - ufw allow 443/tcp comment "HTTPS"
  - ufw allow 9090/tcp comment "Prometheus"
  - ufw allow 3000/tcp comment "Grafana"
  - ufw allow 9100/tcp comment "node_exporter"
  - ufw allow from 10.0.0.0/8 comment "Private network"
  - ufw --force enable

  # Enable and start fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # Enable NTP
  - systemctl enable ntp
  - systemctl start ntp

  # Enable node_exporter
  - systemctl enable prometheus-node-exporter
  - systemctl start prometheus-node-exporter

  # Create Strand directories
  - mkdir -p /opt/strand/bin
  - mkdir -p /opt/strand/config
  - mkdir -p /opt/strand/data
  - mkdir -p /var/log/strand
  - chown -R strand:strand /opt/strand /var/log/strand

  # Set up log rotation for Strand
  - |
    cat > /etc/logrotate.d/strand <<'EOF'
    /var/log/strand/*.log {
        daily
        rotate 14
        compress
        delaycompress
        missingok
        notifempty
        create 0640 strand strand
        postrotate
            systemctl reload strand-cloud 2>/dev/null || true
        endscript
    }
    EOF

final_message: "Strand control-plane node ${HOSTNAME} ready after $UPTIME seconds"
