# ==========================================================
# Strand Protocol -- Full Stack Docker Compose
# ==========================================================
#
# Usage:
#   docker compose up                       -- start default services
#   docker compose up --build               -- rebuild and start
#   docker compose up -d                    -- start in background
#   docker compose --profile allinone up    -- start all-in-one mode
#   docker compose --profile examples up    -- start with example servers
#   docker compose down                     -- stop all services
#   docker compose logs -f                  -- follow logs
#

services:
  # --------------------------------------------------------
  # strand-cloud: Control-plane API server
  # --------------------------------------------------------
  strand-cloud:
    build:
      context: ./strand-cloud
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - STRAND_ADDR=0.0.0.0:8080
      - STRAND_STORE_TYPE=memory
    healthcheck:
      test: ["CMD", "/healthcheck"]
      interval: 5s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  # --------------------------------------------------------
  # strand-allinone: All-in-one binary (control plane + agent + CA)
  # Activated with: docker compose --profile allinone up
  # --------------------------------------------------------
  strand-allinone:
    build:
      context: ./strand-cloud
      dockerfile: Dockerfile
    command: ["/strand-allinone"]
    ports:
      - "8081:8080"
    profiles:
      - allinone
    restart: unless-stopped

  # --------------------------------------------------------
  # strandapi-inference: Mock inference server (example)
  # --------------------------------------------------------
  strandapi-inference:
    build:
      context: ./strandapi
      dockerfile: Dockerfile
    ports:
      - "9000:9000"
    environment:
      - STRANDAPI_ADDR=0.0.0.0:9000
    depends_on:
      strand-cloud:
        condition: service_healthy
    restart: unless-stopped

  # --------------------------------------------------------
  # strandapi-echo: Echo server (example)
  # Activated with: docker compose --profile examples up
  # --------------------------------------------------------
  strandapi-echo:
    build:
      context: ./strandapi
      dockerfile: Dockerfile
    command: ["/strandapi-echo"]
    ports:
      - "9002:9000"
    environment:
      - STRANDAPI_ADDR=0.0.0.0:9000
    profiles:
      - examples
    restart: unless-stopped

  # --------------------------------------------------------
  # strandapi-httpbridge: OpenAI-compatible HTTP frontend
  # Browse to http://localhost:9001 to interact via the UI.
  # --------------------------------------------------------
  strandapi-httpbridge:
    build:
      context: ./strandapi
      dockerfile: Dockerfile
    entrypoint: ["/strandapi-httpbridge", "0.0.0.0:9001"]
    ports:
      - "9001:9001"
    depends_on:
      strand-cloud:
        condition: service_healthy
    restart: unless-stopped
